<script>
// The url for the tab in which we activated the command.
var baseUrl;

// The note if any for this pinboard bookmark
var note;

// The string of tags for this pinboard bookmark
var tags;

// True if we have sufficient content to actually register
// a bookmark. The minimum content is at least one tag.
var valid;

/**
 * For each entered character, update the default displayed action.
 */
chrome.omnibox.onInputChanged.addListener(function(text, suggest) {
  window.console.info('typed: ' + text)
  window.console.info('url: ' + baseUrl)
      
  var chunks = text.split(' ');
  
  if (text == "") {
    // No arguments. We require at least one
    valid = false;
    if (baseUrl) {
      chrome.omnibox.setDefaultSuggestion({
        description: '<dim>Enter tags and note for page' + baseUrl + '</url></dim>'
      });
    } else {
      chrome.omnibox.setDefaultSuggestion({
        description: '<dim>Enter tags and note for page</dim>'
      });
    }
  } else if (text != "" && chunks.length == 1) {
    // No note, only a tag.
    tags = chunks[0];
    note = null;
    valid = true;
    chrome.omnibox.setDefaultSuggestion({
      description: 'Tag: <match>' + tags + '</match> ' +
      '<dim>for url <url>' + baseUrl + '</url></dim>'
    });
  } else {
    // tag and note
    valid = true;
    tags = chunks[0];
    note = chunks.slice(1).join(' ');
    chrome.omnibox.setDefaultSuggestion({
      description: 'Tag: <match>' + tags + '</match>' +
      ' Note: <match>' + note + '</match> <dim>for url <url>' +
      baseUrl + '</url></dim>'
    });
  }
});


function resetState() {
  baseUrl = null;
  note = null;
  tags = null;
  valid = false;
}

function resetDefaultSuggestion() {
  resetState();
  chrome.omnibox.setDefaultSuggestion({
    description: 'Add bookmark to pinboard'
  });
}

resetDefaultSuggestion();

// Called once after typing the activation keyword.
// Rests the state and stashes the url.
chrome.omnibox.onInputStarted.addListener(function() {
  resetState(); // Reset our state.
  chrome.tabs.getSelected(null, function(tab) { // Grab the url for use later.
    baseUrl = tab.url;
  });
  chrome.omnibox.setDefaultSuggestion({
    description: '<dim>Enter tags and note for url <url>' + baseUrl + '</url></dim>'
  });
});

chrome.omnibox.onInputCancelled.addListener(function() {
  resetDefaultSuggestion();
});

// Constructs an API url for pinboard. All urls have a standard
// structure: a dictionary of key/value pairs, an actual method
// name and authentication data.
function vendURL(method, user, pass, dict) {
  var url = 'https://' + user + ':' + pass + '@api.pinboard.in/v1/' + method + '?';
  var keyval = [];
  for (var key in dict) {
    keyval.push(key + '=' + encodeURI(dict[key]));
  }
  url = url + (keyval.join('&'));
  return url;
}

// TODO(rjkroege): get auth info from a config page.
function trySavingBookmark(url) {
  var req = new XMLHttpRequest();
  req.open("GET", url, true);
  req.onreadystatechange = function() {
    if (req.readyState == 4) {
      if (req.status != 200 &&
          req.responseXML.childNodes[0].attributes['code'].value != 'done') {
        // We have a problem
        // TODO(rjkroege): retry here a few times with growing backoff
        // TODO(rjkroege): need to track the timeout before we add retry so
        // we preserve the bookmark time. (Or does it matter very much?)
        // Worry about several bookmark requests in flight at a time?
        alert('Posting the bookmark did not succeed.');
      }
    }
  }
  req.send(null);
}

chrome.omnibox.onInputEntered.addListener(function(text) {
  // It is possible that I need to update the state here?
  // Or not? Let's be lazy and not do it for now.

  window.console.info('we entered on our command. should make a bookmark now, tags:' +
      tags + " note: " + note);

  if (valid) {
    // insert the necessary parameters here
    var dict = {
      url: baseUrl,
      description: 'todo',
      extended: note,
      tags: tags
    };
    // TODO(rjkroege): strip the password.
    var url = vendURL('posts/add', 'rjkroege', 'foo', dict);
    // comment out
    // trySavingBookmark(url);
    window.console.info('rest api: sending url <' + url + '>');
  }
});
</script>
